name: Deploy AttendanceWeb (Production)

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup server directory
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            sudo mkdir -p /var/www/python.sicsglobal.com/attendance_web/dist
            sudo chown -R $USER:$USER /var/www/python.sicsglobal.com/attendance_web
            sudo chmod -R 755 /var/www/python.sicsglobal.com/attendance_web

      - name: Clean up server directory
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /var/www/python.sicsglobal.com/attendance_web
            rm -rf dist/* || true

      - name: Build production assets
        run: |
          echo "Building AttendanceWeb production assets..."
          # Inject environment variables dynamically from GitHub Secrets
          echo "VITE_BACKEND_ATTENDANCE=${{ secrets.VITE_BACKEND_ATTENDANCE }}" > .env.production
          echo "VITE_API_KEY_ATTENDANCE=${{ secrets.VITE_API_KEY_ATTENDANCE }}" >> .env.production
          
          # Build using Docker
          docker build -t attendance-web-builder -f Dockerfile.prod .
          docker create --name temp_attendance_builder attendance-web-builder
          docker cp temp_attendance_builder:/app/dist ./dist
          docker rm temp_attendance_builder

      - name: Copy built assets to server
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "dist/"
          target: "/var/www/python.sicsglobal.com/attendance_web/dist/"
          strip_components: 1
          overwrite: true

      - name: Verify deployment
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            if [ ! -d "/var/www/python.sicsglobal.com/attendance_web/dist" ] || [ -z "$(ls -A /var/www/python.sicsglobal.com/attendance_web/dist)" ]; then
              echo "::error::Production assets were not deployed correctly"
              exit 1
            fi
            echo "âœ… AttendanceWeb deployed successfully to /var/www/python.sicsglobal.com/attendance_web/dist"
